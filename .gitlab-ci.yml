stages:
  - lint
  - build
  - deploy

variables:
  REGISTRY: registry.gitlab.com/$CI_PROJECT_PATH
  API_IMAGE: $REGISTRY/api
  NGINX_IMAGE: $REGISTRY/nginx

# ── Lint ───────────────────────────────────────────────────
lint:client:
  stage: lint
  image: node:22-alpine
  script:
    - cd client/web && npm ci && npm run lint

lint:api:
  stage: lint
  image: node:22-alpine
  script:
    - cd api && npm install && npx tsc --noEmit

# ── Build ──────────────────────────────────────────────────
build:images:
  stage: build
  image: docker:27
  services: [docker:27-dind]
  before_script:
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f api/Dockerfile --target prod -t $API_IMAGE:$CI_COMMIT_SHA -t $API_IMAGE:latest ./api
    - docker build -f nginx/Dockerfile -t $NGINX_IMAGE:$CI_COMMIT_SHA -t $NGINX_IMAGE:latest .
    - docker push $API_IMAGE:$CI_COMMIT_SHA
    - docker push $API_IMAGE:latest
    - docker push $NGINX_IMAGE:$CI_COMMIT_SHA
    - docker push $NGINX_IMAGE:latest
  only: [main]

# ── Deploy ─────────────────────────────────────────────────
deploy:production:
  stage: deploy
  image: alpine:3.20
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - mkdir -p ~/.ssh
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - scp docker-compose.yml docker-compose.prod.yml $SERVER_USER@$SERVER_HOST:/opt/cineva/
    - ssh $SERVER_USER@$SERVER_HOST "mkdir -p /opt/cineva/nginx"
    - scp nginx/nginx.prod.conf $SERVER_USER@$SERVER_HOST:/opt/cineva/nginx/
    - |
      ssh $SERVER_USER@$SERVER_HOST "
        cd /opt/cineva &&
        cat > .env << 'ENVEOF'
      POSTGRES_DB=$POSTGRES_DB
      POSTGRES_USER=$POSTGRES_USER
      POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      CORS_ORIGIN=https://cineva.nl
      PORT=3000
      ENVEOF
        docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD $CI_REGISTRY &&
        docker compose -f docker-compose.yml -f docker-compose.prod.yml pull &&
        docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --remove-orphans
      "
  only: [main]
  environment:
    name: production
    url: https://cineva.nl
